name: CI-CD Pipeline

on:
  push:
    branches: [develop, staging, main]
  pull_request:
    branches: [develop, staging, main]

env:
  IMAGE_NAME: titanic-api
  REGISTRY: docker.io
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  # ---------------- CI ----------------
  ci:
    name: CI - Test, Lint, Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'
      
      # Cache pip dependencies
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.local
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run unit tests
        run: |
          export PYTHONPATH=$(pwd)
          pytest tests/unit --cov=app --cov-report=term
      
      - name: Lint code
        run: flake8 .

  # ---------------- BUILD ----------------
  build:
    name: Build & Push Image
    runs-on: ubuntu-latest
    needs: ci
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build & Push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}
            ${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:dev-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  # ---------------- DEPLOY TO DEV (Self-Hosted) ----------------
  deploy-dev:
    name: Deploy to Dev (Minikube)
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: development
      url: http://dev.titanic-api.local
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Cache Kubernetes tools
      - name: Cache Kubernetes tools
        uses: actions/cache@v3
        id: k8s-tools-cache
        with:
          path: |
            /usr/local/bin/kubectl
            /usr/local/bin/kustomize
          key: ${{ runner.os }}-k8s-tools-v1
      
      - name: Verify tools are installed
        if: steps.k8s-tools-cache.outputs.cache-hit != 'true'
        run: |
          echo "Installing Kubernetes tools..."
          
          # Install kubectl
          if ! command -v kubectl &> /dev/null; then
            echo "Installing kubectl..."
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
          fi
          
          # Install kustomize
          if ! command -v kustomize &> /dev/null; then
            echo "Installing kustomize..."
            curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
            sudo mv kustomize /usr/local/bin/
          fi
      
      - name: Verify installations
        run: |
          kubectl version --client
          kustomize version
      
      - name: Verify Minikube is running
        run: |
          if ! minikube status &> /dev/null; then
            echo "Starting Minikube..."
            minikube start --cpus=4 --memory=8192
          else
            echo "Minikube is already running"
          fi
          minikube status
      
      - name: Pull and load image to Minikube
        run: |
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}"
          
          echo "Pulling image: $IMAGE"
          docker pull $IMAGE
          
          echo "Loading image into Minikube..."
          minikube image load $IMAGE
          
          # Verify image is loaded
          echo "Verifying image in Minikube..."
          minikube image ls | grep titanic-api
      
      - name: Create namespace
        run: |
          echo "Creating namespace if it doesn't exist..."
          kubectl create namespace titanic-api-dev --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Update kustomization with new image
        run: |
          cd k8s/overlays/dev
          
          # Update the image tag
          kustomize edit set image titanic-api=${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}
          
          # Show what will be applied
          echo "=== Generated manifests ==="
          kustomize build .
      
      - name: Deploy to Kubernetes
        run: |
          echo "Applying Kubernetes manifests..."
          kubectl apply -k k8s/overlays/dev
          
          echo "Checking what was created..."
          kubectl get all -n titanic-api-dev
          
          echo "Finding deployment..."
          DEPLOYMENT=$(kubectl get deployment -n titanic-api-dev -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          
          if [ -z "$DEPLOYMENT" ]; then
            echo "❌ Error: No deployment found in namespace titanic-api-dev"
            echo "Resources in namespace:"
            kubectl get all -n titanic-api-dev
            exit 1
          fi
          
          echo "Found deployment: $DEPLOYMENT"
          echo "Waiting for deployment to complete..."
          kubectl rollout status deployment/$DEPLOYMENT -n titanic-api-dev --timeout=5m
      
      - name: Verify deployment
        run: |
          echo "=== Checking pods ==="
          kubectl get pods -n titanic-api-dev -o wide
          
          echo ""
          echo "=== Checking services ==="
          kubectl get svc -n titanic-api-dev
          
          echo ""
          echo "=== Getting service URL ==="
          minikube service list -n titanic-api-dev || true
      
      - name: Health check
        run: |
          echo "Running health check..."
          
          # Wait for at least one pod to be ready
          kubectl wait --for=condition=ready pod -l app=titanic-api -n titanic-api-dev --timeout=2m || true
          
          POD=$(kubectl get pod -n titanic-api-dev -l app=titanic-api -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          
          if [ -n "$POD" ]; then
            echo "Testing health endpoint in pod: $POD"
            kubectl exec -n titanic-api-dev $POD -- curl -f http://localhost:5000/health || echo "⚠️  Health check failed"
          else
            echo "⚠️  No pods found for health check"
          fi
      
      - name: Display deployment info
        if: always()
        run: |
          echo "=== DEPLOYMENT SUMMARY ==="
          echo "Image: ${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}"
          echo "Namespace: titanic-api-dev"
          echo "Time: $(date)"
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n titanic-api-dev -o wide
          echo ""
          echo "=== Deployments ==="
          kubectl get deployments -n titanic-api-dev
          echo ""
          echo "=== Services ==="
          kubectl get svc -n titanic-api-dev
          echo ""
          echo "=== Recent Events ==="
          kubectl get events -n titanic-api-dev --sort-by='.lastTimestamp' | tail -15

  # ---------------- DEPLOY TO STAGING (Self-Hosted) ----------------
  deploy-staging:
    name: Deploy to Staging (Minikube)
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/staging'
    environment:
      name: staging
      url: http://staging.titanic-api.local
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create namespace
        run: |
          kubectl create namespace titanic-api-staging --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Pull and load image to Minikube
        run: |
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}"
          docker pull $IMAGE
          minikube image load $IMAGE
      
      - name: Update kustomization
        run: |
          cd k8s/overlays/staging
          kustomize edit set image titanic-api=${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}
      
      - name: Deploy to Staging
        run: |
          kubectl apply -k k8s/overlays/staging
          
          # Find deployment dynamically
          DEPLOYMENT=$(kubectl get deployment -n titanic-api-staging -o jsonpath='{.items[0].metadata.name}')
          echo "Found deployment: $DEPLOYMENT"
          
          kubectl rollout status deployment/$DEPLOYMENT -n titanic-api-staging --timeout=5m
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          kubectl wait --for=condition=ready pod -l app=titanic-api -n titanic-api-staging --timeout=2m || true
          
          POD=$(kubectl get pod -n titanic-api-staging -l app=titanic-api -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          
          if [ -n "$POD" ]; then
            kubectl exec -n titanic-api-staging $POD -- curl -f http://localhost:5000/health
          fi

  # ---------------- DEPLOY TO PROD (Self-Hosted with Approval) ----------------
  deploy-prod:
    name: Deploy to Production (Minikube)
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: http://prod.titanic-api.local
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create namespace
        run: |
          kubectl create namespace titanic-api-prod --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create backup of current deployment
        run: |
          echo "Creating backup..."
          BACKUP_FILE="/tmp/deployment-backup-$(date +%Y%m%d-%H%M%S).yaml"
          
          if kubectl get deployment -n titanic-api-prod &> /dev/null; then
            kubectl get deployment -n titanic-api-prod -o yaml > $BACKUP_FILE
            echo "✅ Backup saved to: $BACKUP_FILE"
          else
            echo "ℹ️  No existing deployment to backup"
          fi
      
      - name: Pull and load image to Minikube
        run: |
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}"
          docker pull $IMAGE
          minikube image load $IMAGE
      
      - name: Update kustomization
        run: |
          cd k8s/overlays/prod
          kustomize edit set image titanic-api=${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}
      
      - name: Deploy to Production
        run: |
          kubectl apply -k k8s/overlays/prod
          
          # Find deployment dynamically
          DEPLOYMENT=$(kubectl get deployment -n titanic-api-prod -o jsonpath='{.items[0].metadata.name}')
          echo "Found deployment: $DEPLOYMENT"
          
          kubectl rollout status deployment/$DEPLOYMENT -n titanic-api-prod --timeout=10m
      
      - name: Comprehensive health check
        run: |
          echo "Running comprehensive health checks..."
          
          # Wait for all pods to be ready
          kubectl wait --for=condition=ready pod -l app=titanic-api -n titanic-api-prod --timeout=5m
          
          # Test health endpoint on all pods
          PODS=$(kubectl get pod -n titanic-api-prod -l app=titanic-api -o jsonpath='{.items[*].metadata.name}')
          
          for POD in $PODS; do
            echo "Testing pod: $POD"
            kubectl exec -n titanic-api-prod $POD -- curl -f http://localhost:5000/health
          done
          
          echo "✅ All health checks passed!"
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "❌ Deployment failed! Rolling back..."
          
          DEPLOYMENT=$(kubectl get deployment -n titanic-api-prod -o jsonpath='{.items[0].metadata.name}')
          kubectl rollout undo deployment/$DEPLOYMENT -n titanic-api-prod
          kubectl rollout status deployment/$DEPLOYMENT -n titanic-api-prod --timeout=5m
          
          echo "✅ Rollback completed"
      
      - name: Production deployment summary
        if: always()
        run: |
          echo "=== PRODUCTION DEPLOYMENT SUMMARY ==="
          echo "Image: ${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}"
          echo "Time: $(date)"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "=== All Resources ==="
          kubectl get all -n titanic-api-prod
          echo ""
          echo "=== Deployment Details ==="
          kubectl describe deployment -n titanic-api-prod