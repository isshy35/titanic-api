name: CI-CD Pipeline

on:
  push:
    branches: [develop, staging, main]
  pull_request:
    branches: [develop, staging, main]

env:
  IMAGE_NAME: titanic-api
  REGISTRY: docker.io
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  # ---------------- CI ----------------
  ci:
    name: CI - Test, Lint, Build
    runs-on: ubuntu-latest  # Keep CI on GitHub runners (faster, cleaner)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run unit tests
        run: |
          export PYTHONPATH=$(pwd)
          pytest tests/unit --cov=app --cov-report=term
      
      - name: Lint code
        run: flake8 .

  # ---------------- BUILD ----------------
  build:
    name: Build & Push Image
    runs-on: ubuntu-latest  # Keep build on GitHub runners
    needs: ci
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build & Push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}
            ${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:dev-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ---------------- DEPLOY TO DEV (Self-Hosted) ----------------
  deploy-dev:
    name: Deploy to Dev (Minikube)
    runs-on: self-hosted  # Changed to self-hosted
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: development
      url: http://dev.titanic-api.local
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify tools are installed
        run: |
          echo "Checking required tools..."
          
          # Check kubectl
          if ! command -v kubectl &> /dev/null; then
            echo "Installing kubectl..."
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
          fi
          kubectl version --client
          
          # Check kustomize
          if ! command -v kustomize &> /dev/null; then
            echo "Installing kustomize..."
            curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
            sudo mv kustomize /usr/local/bin/
          fi
          kustomize version
      
      - name: Verify Minikube is running
        run: |
          if ! minikube status | grep -q "Running"; then
            echo "Starting Minikube..."
            minikube start --cpus=4 --memory=8192
          else
            echo "Minikube is already running"
          fi
          minikube status
      
      - name: Pull and load image to Minikube
        run: |
          echo "Pulling image from Docker Hub..."
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}
          
          echo "Loading image into Minikube..."
          minikube image load ${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}
          
          # Verify image is loaded
          minikube image ls | grep titanic-api
      
      - name: Update kustomization with new image
        run: |
          cd k8s/overlays/dev
          
          # Update the image tag
          kustomize edit set image titanic-api=${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}
          
          # Show what will be applied
          echo "Generated manifests:"
          kustomize build .
      
      - name: Deploy to Kubernetes
        run: |
          echo "Applying Kubernetes manifests..."
          kubectl apply -k k8s/overlays/dev
          
          echo "Waiting for deployment to complete..."
          kubectl rollout status deployment/dev-titanic-api -n titanic-api-dev --timeout=5m
      
      - name: Verify deployment
        run: |
          echo "Checking pods..."
          kubectl get pods -n titanic-api-dev
          
          echo "Checking services..."
          kubectl get svc -n titanic-api-dev
          
          echo "Getting service URL..."
          minikube service dev-titanic-api-service -n titanic-api-dev --url || true
      
      - name: Health check
        run: |
          echo "Running health check..."
          POD=$(kubectl get pod -n titanic-api-dev -l app=titanic-api -o jsonpath='{.items[0].metadata.name}')
          
          if [ -n "$POD" ]; then
            echo "Testing health endpoint in pod: $POD"
            kubectl exec -n titanic-api-dev $POD -- curl -f http://localhost:5000/health || echo "Health check failed"
          else
            echo "No pods found"
          fi
      
      - name: Display deployment info
        if: always()
        run: |
          echo "=== Deployment Summary ==="
          echo "Image: ${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}"
          echo "Namespace: titanic-api-dev"
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n titanic-api-dev -o wide
          echo ""
          echo "=== Services ==="
          kubectl get svc -n titanic-api-dev
          echo ""
          echo "=== Events (last 10) ==="
          kubectl get events -n titanic-api-dev --sort-by='.lastTimestamp' | tail -10

  # ---------------- DEPLOY TO STAGING (Self-Hosted) ----------------
  deploy-staging:
    name: Deploy to Staging (Minikube)
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/staging'
    environment:
      name: staging
      url: http://staging.titanic-api.local
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Pull and load image to Minikube
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}
          minikube image load ${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}
      
      - name: Update kustomization
        run: |
          cd k8s/overlays/staging
          kustomize edit set image titanic-api=${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}
      
      - name: Deploy to Staging
        run: |
          kubectl apply -k k8s/overlays/staging
          kubectl rollout status deployment/staging-titanic-api -n titanic-api-staging --timeout=5m
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          POD=$(kubectl get pod -n titanic-api-staging -l app=titanic-api -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n titanic-api-staging $POD -- curl -f http://localhost:5000/health

  # ---------------- DEPLOY TO PROD (Self-Hosted with Approval) ----------------
  deploy-prod:
    name: Deploy to Production (Minikube)
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: http://prod.titanic-api.local
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create backup of current deployment
        run: |
          echo "Creating backup..."
          kubectl get deployment prod-titanic-api -n titanic-api-prod -o yaml > /tmp/deployment-backup-$(date +%Y%m%d-%H%M%S).yaml || echo "No existing deployment to backup"
      
      - name: Pull and load image to Minikube
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}
          minikube image load ${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}
      
      - name: Update kustomization
        run: |
          cd k8s/overlays/prod
          kustomize edit set image titanic-api=${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}
      
      - name: Deploy to Production
        run: |
          kubectl apply -k k8s/overlays/prod
          kubectl rollout status deployment/prod-titanic-api -n titanic-api-prod --timeout=10m
      
      - name: Comprehensive health check
        run: |
          echo "Running comprehensive health checks..."
          
          # Check all pods are ready
          kubectl wait --for=condition=ready pod -l app=titanic-api -n titanic-api-prod --timeout=5m
          
          # Test health endpoint
          POD=$(kubectl get pod -n titanic-api-prod -l app=titanic-api -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n titanic-api-prod $POD -- curl -f http://localhost:5000/health
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed! Rolling back..."
          kubectl rollout undo deployment/prod-titanic-api -n titanic-api-prod
          kubectl rollout status deployment/prod-titanic-api -n titanic-api-prod
      
      - name: Production deployment summary
        if: always()
        run: |
          echo "=== PRODUCTION DEPLOYMENT SUMMARY ==="
          echo "Image: ${{ secrets.DOCKERHUB_USERNAME }}/titanic-api:${{ github.sha }}"
          echo "Time: $(date)"
          echo "Actor: ${{ github.actor }}"
          echo ""
          kubectl get all -n titanic-api-prod